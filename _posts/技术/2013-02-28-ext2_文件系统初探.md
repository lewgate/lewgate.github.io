---
layout: post
title: ext2 文件系统初探
category: 技术
tags: Linux File_System
keywords: 
description: 
---
在平时有没有好奇过，同一个分区下的文件移动几乎是不需要时间的，即使那个文件十分的巨大，但是在不同分区移动时，却是相当的耗时。有没有好奇过文件夹到底是个什么东西，我们是怎么一步步找到文件的。本篇博文将以*ext2*文件系统为例尽量解开这个疑问。

*Ext2*文件系统是经典的*Linux*系统，*ext2*和*ext3*是目前*Linux*系统的主要文件系统。

在一般的文件系统中，可访问的磁盘的最小单位是块（*block*），也就是说一个非空文件至少占用一个*block*（块大小一般为*2KB，4KB*或*8KB*），块是文件系统管理这个磁盘的基本单位，一般情况下每个*block*在一个分区中有一个独一无二的*32bits*整数表示的块号，通过块号可以在一个分区中找到对应的块的位置。我们可能不会太多的涉及组的东西，只从最基础的角度理解文件系统。在*Linux*中主要的文件类型有7种，分别是：普通文件，目录，字符设备，块设备，命名管道，套接字和符合链接，分别由数值1-7来代表。我们主要将目光集中在普通文件，目录和符号链接上。

假设有下面这样的一个文件夹，分别有三个文件（*file_1,file_2,file_3*）和子目录(*foder_1, folder_2, folder_3*)，三个子目录中又分别有三个文件(*file_11,file_12, file_13; file_21, file_22, file_23; file_31, file_32, file_33*)。本文都是一个这个目录为例展开。

![folder_structure](/public/img/ext2/1.PNG)

下面我就集中在*inode*的结构上。按照*POSIX*的规定，*inode*节点至少要存储以下信息（只列出常见的条目）：
- 文件大小（*Byte*为单位）
- 文件拥有者的*ID*
- 文件的访问控制
- 时间戳
- 硬链接计数（后边会涉及）
- 指向用户数据的块指

其中指向用户数据的块指针一共15个，其中12个直接块指针，一级、二级、三级块指针各一个。假设一个块的大小为b字节，12个直接块指针直接指向12个块，也就是说通过直接访问的用户数据可以有12b字节；一级间接指针首先指向一个块，但是此块内部数据为块指针（也就是块号），由于块号都是4字节大小的，所以通过一级间接指针可以访问<img src="http://latex.codecogs.com/gif.latex?\frac{b^2}{4}" title="\frac{b^2}{4}" />字节大小的数据，二级和三级间接指针以此类推，容易得到一个文件的大小最大为<img src="http://latex.codecogs.com/gif.latex?\left&space;[&space;(\frac{b}{4})^3&plus;(\frac{b}{4})^2&plus;\frac{b}{4}&plus;12&space;\right&space;]\times&space;b" title="\left [ (\frac{b}{4})^3+(\frac{b}{4})^2+\frac{b}{4}+12 \right ]\times b" />；如下图（摘自[《深入理解Linux内核》](http://www.amazon.com/Understanding-Linux-Kernel-Third-Edition/dp/0596005652/ref=sr_1_1?ie=UTF8&qid=1414327369&sr=8-1&keywords=understanding+linux+kernel)）